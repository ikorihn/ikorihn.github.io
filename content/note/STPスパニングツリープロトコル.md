---
title: STPスパニングツリープロトコル
date: 2024-03-09T22:51:00+09:00
tags:
  - ネスペ
---


物理的にループになっているL2ネットワークにおいて、データが無限にループする **ブロードキャストストーム** を防ぐためのプロトコル。

## 目的

- ループの回避
- 冗長性確保による信頼性向上 [[ネスペ試験で出てくる冗長性に関する用語集]]


## ブリッジIDとポート優先度

各ブリッジやスイッチに一意のブリッジIDが割り当てられる。
各ポートには優先度があり、これに基づいてSTPは冗長な経路を選択する。

## BPDU（Bridge Protocol Data Unit）

STPを制御するための特別なデータフレーム。
一定時間(2秒)ごとに、スイッチングハブから他のスイッチングハブへとブロードキャストされる。
BPDUには、ブリッジID、ポートID、パスコストなどの情報が含まれ、ネットワークの状態を判断できる。

ネットワークの変化を検知すると再計算を行い、遮断ポートの開放や変更を行うことで最適な通信経路を維持する。

### ブリッジID

ブリッジの優先順位とMACアドレスを組み合わせた値。
優先度は管理者が設定する。
ブリッジIDが最も小さい値のスイッチが **ルートブリッジ** となり、ツリーの中心となる。
ルートブリッジがBPDUを送信し、複数の経路からBPDUが届けばループが発生していると判断できる。

### パスコスト

ルートブリッジまでの距離を示す情報。回線の速度も計算に入れられる。
コストがより小さい経路が選択される。

### ルートポート(RP)の選出

**各非ルートブリッジで、ルートブリッジに一番近い(パスコストが最も小さい)ポート。ブリッジごとに1つ**
ルートブリッジ自身にはルートポートはない

### 指定ポート(DP)の選出

**各リンクでルートブリッジに最も近いポート。リンクごとに1つ**
ルートブリッジのポートはすべて指定ポートになる。

### 非指定ポート(NDP)の選出

ルートポートでも指定ポートでもないポートは非指定ポートで、ブロッキング状態となりデータフレームは転送しなくなる。

## ポートの状態遷移

STPは、各ポートに対してブロッキング、リスニング、ラーニング、フォワーディングなどの異なる状態を持つ

- ブロッキング: データを転送しない
- リスニング: STPの状態を確認中
- ラーニング: STPの学習中
- フォワーディング: データ転送をする

**ルートブリッジから最も遠いブリッジ**のポートがブロックされる。これによりネットワークがツリー型になる。

## 関連技術

### PVST+

Per VLAN Spanning Tree Plus
複数のVLANで個別のネットワーク接続形態を構成することが可能な技術

### RSTP(Rapid Spanning Tree Protocol)

STPの再計算時間が大幅に短縮され、ネットワーク異常からの復旧が高速になっている。

## STPの運用負荷を軽減

STPは設定が複雑で、設定ミスによるトラブルが生じやすい難点がある。また、障害発生時の経路の切り替えに時間がかかる。

STPを使わずにネットワークの冗長性を確保する方法として、
[[スタック接続]] や [[リンクアグリゲーション]] がある。
複数のスイッチングハブを論理的に1つにすることで取り扱いがしやすくなり、configも１つで管理できる。
これらの技術を使うことにより運用管理の負荷を軽減できる。

